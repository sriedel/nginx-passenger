#!/usr/bin/ruby
# put in /etc/munin/plugins and restart munin-node
# by Dan Manges, http://www.dcmanges.com/blog/rails-application-visualization-with-munin
# NOTE: you might need to add munin to allow passwordless sudo for passenger-memory-stats 

def output_config
  puts <<-END
graph_category App
graph_title Passenger memory stats 
graph_vlabel count

memory.label memory
END
  exit 0
end

def output_values
  status = `sudo /usr/bin/passenger-memory-stats | tail -1`
  unless $?.success?
    $stderr.puts "failed executing passenger-memory-stats"
    exit 1
  end
  status =~ /(\d+\.\d+)/
  puts "memory.value #{$1}"
end

if ARGV[0] == "config"
  output_config
else
  output_values
end

